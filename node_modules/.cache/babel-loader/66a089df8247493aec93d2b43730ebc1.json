{"ast":null,"code":"function Node(from, to) {\n  this.visits = 1;\n  this.score = 0;\n  this.children = null;\n  this.to = to || -1;\n  this.from = from || -1;\n} //\n// Node.prototype.opponent = function () {\n//     return this.player ^ 8;\n// }\n\n\nNode.prototype.append = function (child) {\n  if (!this.children) this.children = [child];else this.children.push(child);\n};\n\nNode.prototype.branch = function (state) {\n  state.clearMoves();\n  state.getAllMoves(state.player);\n  const shift = state.player === 12 ? BIT_MAX_PI : 0;\n\n  for (let pi = shift; pi < BIT_MAX_PI + shift; pi++) {\n    const nMoves = state.moves[pi].length;\n    const from = state.board[BOARD_AREA + pi];\n\n    for (let i = 0; i < nMoves; i++) {\n      const to = state.moves[pi][i] & BIT_AREA - 1;\n      let child = new Node(from, to);\n      this.append(child);\n    }\n  }\n};\n\nNode.prototype.playFor = function (state) {\n  return state.doMove(this.from, this.to);\n};\n\nNode.prototype.ucb = function (coeff) {\n  var score = this.score / this.visits;\n  return score + Math.sqrt(coeff / this.visits);\n};\n\nNode.prototype.findBestChild = function () {\n  var coeff = 20 * Math.log(this.visits);\n  var bestScore = -Infinity;\n  var bestChild = null;\n\n  for (var i = 0; i < this.children.length; i++) {\n    var child = this.children[i];\n    var score = child.ucb(coeff);\n\n    if (score > bestScore) {\n      bestScore = score;\n      bestChild = child;\n    }\n  }\n\n  return bestChild;\n};\n\nexport function UCT(startState, maxTime) {\n  this.root = new Node();\n  this.startState = startState;\n  let MaturityThreshold = 200; // Populate the first node.\n\n  this.root.branch(startState);\n  var history = [this.root];\n  var TotalPlayouts = 0;\n  var start = Date.now();\n  var elapsedTime;\n\n  while (elapsedTime < maxTime) {\n    for (var i = 0; i < 500; i++) this.run();\n\n    TotalPlayouts += 500;\n    elapsedTime = Date.now() - start;\n  }\n\n  var bestChild = null;\n  var bestScore = -Infinity;\n\n  for (var i = 0; i < this.root.children.length; i++) {\n    var child = this.root.children[i];\n\n    if (child.visits > bestScore) {\n      bestChild = child;\n      bestScore = child.visits;\n    }\n  }\n\n  return {\n    elapsed: elapsed,\n    playouts: TotalPlayouts,\n    from: bestChild.from,\n    to: bestChild.to\n  };\n}\n\nUCT.prototype.playout = function (state) {\n  var nmoves = 0;\n\n  while (++nmoves < 60) {\n    var result = state.moveRandom(); //returns if won\n\n    if (result) return result;\n  }\n\n  return state.score();\n};\n\nUCT.protoype.run = function () {\n  const state = this.startState.copy();\n  const node = this.root;\n  let depth = 1;\n  let winner = 0;\n\n  while (true) {\n    if (node.children === null) {\n      if (node.visits >= MaturityThreshold) {\n        node.branch(state); // Leaf node - go directly to update.\n\n        if (node.children === null) {\n          winner = node.opponent();\n          history[depth++] = node;\n          break;\n        }\n\n        continue;\n      }\n\n      winner = this.playout(state);\n      break;\n    }\n\n    node = node.findBestChild();\n    history[depth++] = node;\n\n    if (node.playFor(state)) {\n      winner = board.player;\n      break;\n    }\n  }\n\n  for (var i = 0; i < depth; i++) {\n    node = history[i];\n    node.visits++;\n    if (winner == node.player) node.score += 1;else if (winner != 0) node.score -= 1;\n  }\n};","map":{"version":3,"sources":["/Users/bacchus/git/Leap/src/js/ai.js"],"names":["Node","from","to","visits","score","children","prototype","append","child","push","branch","state","clearMoves","getAllMoves","player","shift","BIT_MAX_PI","pi","nMoves","moves","length","board","BOARD_AREA","i","BIT_AREA","playFor","doMove","ucb","coeff","Math","sqrt","findBestChild","log","bestScore","Infinity","bestChild","UCT","startState","maxTime","root","MaturityThreshold","history","TotalPlayouts","start","Date","now","elapsedTime","run","elapsed","playouts","playout","nmoves","result","moveRandom","protoype","copy","node","depth","winner","opponent"],"mappings":"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","sourcesContent":["\n\nfunction Node(from, to) {\n    this.visits = 1;\n    this.score = 0;\n    this.children = null;\n    this.to = to || -1;\n    this.from = from || -1;\n}\n//\n// Node.prototype.opponent = function () {\n//     return this.player ^ 8;\n// }\n\nNode.prototype.append = function (child) {\n    if (!this.children) this.children = [child];\n    else this.children.push(child);\n}\n\nNode.prototype.branch = function (state) {\n    state.clearMoves();\n    state.getAllMoves(state.player);\n\n    const shift = (state.player === 12) ? BIT_MAX_PI : 0;\n    for (let pi = shift; pi < BIT_MAX_PI + shift; pi++) {\n      const nMoves = state.moves[pi].length;\n      const from = state.board[BOARD_AREA + pi];\n\n      for (let i = 0; i < nMoves; i++) {\n        const to = ( state.moves[pi][i] & (BIT_AREA - 1) );\n        let child = new Node(from, to);\n        this.append(child);\n      }\n  }\n}\n\nNode.prototype.playFor = function (state) {\n    return state.doMove(this.from, this.to);\n}\n\nNode.prototype.ucb = function (coeff) {\n    var score = (this.score / this.visits);\n    return score + Math.sqrt(coeff / this.visits);\n}\n\nNode.prototype.findBestChild = function () {\n    var coeff = 20 * Math.log(this.visits);\n    var bestScore = -Infinity;\n    var bestChild = null;\n    for (var i = 0; i < this.children.length; i++) {\n        var child = this.children[i];\n        var score = child.ucb(coeff);\n        if (score > bestScore) {\n            bestScore = score;\n            bestChild = child;\n        }\n    }\n    return bestChild;\n}\n\n\n\n\n\nexport function UCT(startState, maxTime) {\n  this.root = new Node();\n  this.startState = startState;\n  let MaturityThreshold = 200;\n\n  // Populate the first node.\n  this.root.branch(startState);\n  var history = [this.root];\n\n  var TotalPlayouts = 0;\n  var start = Date.now();\n  var elapsedTime;\n  while (elapsedTime < maxTime) {\n      for (var i = 0; i < 500; i++) this.run();\n      TotalPlayouts += 500;\n      elapsedTime = Date.now() - start;\n  }\n\n  var bestChild = null;\n  var bestScore = -Infinity;\n  for (var i = 0; i < this.root.children.length; i++) {\n      var child = this.root.children[i];\n      if (child.visits > bestScore) {\n          bestChild = child;\n          bestScore = child.visits;\n      }\n  }\n\n  return {\n    elapsed: elapsed,\n    playouts: TotalPlayouts,\n    from: bestChild.from,\n    to: bestChild.to\n  };\n}\n\nUCT.prototype.playout = function (state) {\n    var nmoves = 0;\n\n    while (++nmoves < 60) {\n        var result = state.moveRandom(); //returns if won\n        if (result) return result;\n    }\n    return state.score();\n}\n\nUCT.protoype.run = function () {\n    const state = this.startState.copy();\n    const node = this.root;\n    let depth = 1;\n    let winner = 0;\n\n    while (true) {\n        if (node.children === null) {\n            if (node.visits >= MaturityThreshold) {\n                node.branch(state);\n\n                // Leaf node - go directly to update.\n                if (node.children === null) {\n                    winner = node.opponent();\n                    history[depth++] = node;\n                    break;\n                }\n                continue;\n            }\n            winner = this.playout(state);\n            break;\n        }\n        node = node.findBestChild();\n        history[depth++] = node;\n        if (node.playFor(state)) {\n            winner = board.player;\n            break;\n        }\n    }\n\n    for (var i = 0; i < depth; i++) {\n        node = history[i];\n        node.visits++;\n        if (winner == node.player)\n            node.score += 1;\n        else if (winner != 0)\n            node.score -= 1;\n    }\n}\n"]},"metadata":{},"sourceType":"module"}